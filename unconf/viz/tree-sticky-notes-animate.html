<!DOCTYPE html>
<meta charset='utf-8'>
<head>
    <title>Animate: Tree to Sticky Notes</title>
    <script src='../../plugins/d3/d3.v4.js'></script>
</head>

<style>
    rect {
        stroke: #05668D;
        fill: white;
        opacity: 0.6;
        stroke-width: 2px;
    }

    rect.clear {
        opacity: 0;
    }

    path {
        fill: none;
        stroke: #05668D;
        opacity: 0.6;
        stroke-width: 2px;
    }

    text {
        font-family: Verdana, "Helvetica Neue", Arial, Helvetica, Geneva, sans-serif;
        font-size: 11px;
        fill: black;
    }
</style>

<svg>
    <g></g>
</svg>
<!--
1) Draw tree (using only round 1 data)
-->

<script>
    var vWidth = 430;
    var vHeight = 700;
    var vRad = 25;
    var stratify = d3.stratify();
    var vColor = ['yellow', 'green', 'pink'];

    // Prepare our physical space
    var g = d3.select('svg').attr('width', vWidth).attr('height', vHeight)
        .select('g').attr('transform', 'translate(40, 20)');

    // Declare d3 layout
    var vLayout = d3.tree().size([vHeight * 0.9, vWidth * 0.7]);

    // Get the data from our JSON file
    d3.csv('data-car-animate.csv', function(error, vCsvData) {
        if (error) throw error;

        vCsvData = vCsvData.filter( function(node) { return node.round === "1"; });

        vData = d3.stratify()(vCsvData);
        drawTree(vData);
    });

    /**
     * Draw our sunburst
     * @param {object} data - Hierarchical data
     */
    function drawTree(data) {
        // Layout + Data
        var vRoot = d3.hierarchy(data);
        var vNodes = vRoot.descendants();
        var vLinks = vLayout(vRoot).links();

        // Draw on screen
        var vLines = g.selectAll('path').data(vLinks).enter().append('path')
            .attr('d', d3.linkHorizontal()
                .x(function(d) { return d.y; })
                .y(function(d) { return d.x; }))
            .transition().duration(1500).style('opacity', 0);

        // Add <g>s
        var vRects = g.selectAll('g').data(vNodes).enter().append('g')
            .attr('transform', function (d) { return 'translate(' + (d.y - vRad) + ',' + (d.x - vRad) + ')'; });

        // Draw <rect>s
        vRects.append('rect').attr('width', vRad * 2).attr('height', vRad * 2).attr('rx', vRad)
            .each( function(d) { d.data.color = vColor[d.depth]});

        // Animate 1: To sticky notes
        vRects.selectAll('rect')
            .transition().delay( function(d) { return d.depth * 500; }).duration(750)
            .attr('rx', 0).transition().duration(750)
            .style('fill', function(d) { return d.data.color; })
            .style('stroke', function(d) { return d.data.color; }).style('opacity', 1);

        // Draw <text>s
        vRects.append('text')
            .attr('text-anchor', 'middle')
            .attr("dominant-baseline", "central")
            .attr('transform', function (d) { return 'translate(' + vRad + ',' + vRad + ')'; })
            .text(function(d) { return d.data.id }).style('opacity', 0)
            .transition().delay(750).duration(750).style('opacity', 1);

        // Animate 2: <g>s To Tabular
        vRects.transition().delay(2000).duration(1000)
            .attr('transform', function(d, i) { return 'translate(40, ' + (i * 60 + 20) + ')'; } );

        // Animate 3: Add 2nd column <rect>s
        vRects.append('rect').attr('class','clear')
            .attr('transform', function (d) { return 'translate(60, 0)'; })
            .attr('width', vRad * 2).attr('height', vRad * 2).attr('rx', vRad).attr('rx', 0)
            .transition().delay(3000).duration(750)
            .style('fill', function(d) { return d.parent ? d.parent.data.color : 'white'; })
            .style('stroke', function(d) { return d.parent ? d.parent.data.color : 'white'; })
            .style('opacity', 1);

        // Animate 3: Add2nd column <text>s
        vRects.append('text')
            .attr('text-anchor', 'middle')
            .attr("dominant-baseline", "central")
            .attr('transform', function (d) { return 'translate(' + (60 + vRad) + ', ' + vRad + ')'; })
            .text(function(d) { return d.parent ? d.parent.data.id : ''; }).style('opacity', 0)
            .transition().delay(3000).duration(750).style('opacity', 1);

        g.append('text').attr('text-anchor', 'middle')
            //.attr("dominant-baseline", "central")
            .attr('transform', function (d) { return 'translate(65, 0)'; })
            .transition().delay(3000).text('id');
        g.append('text').attr('text-anchor', 'middle')
            //.attr("dominant-baseline", "central")
            .attr('transform', function (d) { return 'translate(130, 0)'; })
            .transition().delay(3000).text('parentId');
    }
</script>
